-- title:   Test Cart
-- author:  GR8N8
-- desc:    Test out vector idea
-- site:    website link
-- license: MIT License
-- version: 0.1
-- script:  moon

DEBUG=1

-- compare field of 2 tables
comp=(k)->(a,b)->a[k]<b[k]

-- true if object inherits from type
istype=(o,t)->
	c=o.__class
	while c != nil
		if c == t
			return true
		c=c.__parent
	false

class Matrix
	new:(m={ 1,0,0, 0,1,0, 0,0,1 })=>
		@m=m
	_index:(r,c)=>r*3+c+1
	get:(r,c)=>
		-- adjust for 1 indexed arrays
		assert r*c <= #@m and r*c >= 0
		@m[@_index(r,c)]
	set:(r,c,v)=>
		assert r*c <= #@m and r*c >= 0
		@m[@_index(r,c)]=v
	_apply:(o,fn)=>
		{ a,b,c, d,e,f, g,h,i }=@m
		if "number"== type o
			Matrix {
				fn(a,o),fn(b,o),fn(c,o),
				fn(d,o),fn(e,o),fn(f,o),
				fn(g,o),fn(h,o),fn(i,o),
			}
		else
			assert istype o,Matrix
			{ j,k,l, m,n,o, p,q,r }=o.m
			Matrix {
				fn(a,j),fn(b,k),fn(c,l),
				fn(d,m),fn(e,n),fn(f,o),
				fn(g,p),fn(h,q),fn(i,r),
			}
	__add:(o)=>@_apply o,(a,b)->a+b
	__sub:(o)=>@_apply o,(a,b)->a-b
	__div:(o)=>@_apply o,(a,b)->a/b
	__idiv:(o)=>@_apply o,(a,b)->a//b
	__unm:=>@__mul -1
	__mul:(o)=>
		if "number"==type o
			@_apply o,(a,b)->a*b
		else if istype o,Matrix
			-- computes dot product
			{ a,b,c, d,e,f, g,h,i }=@m
			{ j,k,l, m,n,o, p,q,r }=o.m
			Matrix {
				a*j+b*m+c*p,a*k+b*n+c*q,a*l+b*o+c*r,
				d*j+e*m+f*p,d*k+e*n+f*q,d*l+e*o+f*r,
				g*j+h*m+i*p,g*k+h*n+i*q,g*l+h*o+i*r,
			}
	__tostring:=>
		{ a,b,c, d,e,f, g,h,i }=@m
		"[#{a},#{b},#{c}, #{d},#{e},#{f}, #{g},#{h},#{i}]"

class TransformSet
	new:=>
		@s=Matrix!
		@r=Matrix!
		@t=Matrix!
	translate:(x=0,y=0)=>
		@t*=Matrix {
			1,0,x,
			0,1,y,
			0,0,1,
		}
	scale:(w=1,h=1)=>
		@s*=Matrix {
			w,0,0,
			0,h,0,
			0,0,1,
		}
	reflect:=>@scale -1,-1
	reflect_x:=>@scale -1,1
	reflect_y:=>@scale 1,-1
	shear:(x=0,y=0)=>
		@s*=Matrix {
			1,x,0,
			y,1,0,
			0,0,1,
		}
	rotate:(ang=0)=>
		ang=math.rad ang
		c,s=math.cos(ang),math.sin ang
		@r*=Matrix {
			c,-s,0,
			s, c,0,
			0, 0,1,
		}
	rotate_around_axis:(ang=0,x=0,y=0)=>
		@translate(-x,-y)
		@rotate(ang)
		@translate(x,y)
	apply:(m)=>@s*@r*@t*m

m=Matrix {
	5,0,0
	0,0,0
	1,0,0
}
t=TransformSet!
t\reflect_x!
m1=t\apply m
x=m1\get(0,0)
assert x == -5,"expect x to be -5 but was #{x}"

class Vec
	new:(x=0,y=0)=>
		@x=x
		@y=y
	to_mtrx:=>Matrix {
			@x,0,0,
			@y,0,0,
			1,0,0,
		}
	from:(m)->
		assert istype m,Matrix
		Vec m\get(0,0),m\get(1,0)
	__add:(v)=>@_apply v,(a,b)->a+b
	__sub:(v)=>@_apply v,(a,b)->a-b
	__div:(v)=>@_apply v,(a,b)->a/b
	__idiv:(v)=>@_apply v,(a,b)->a//b
	__mul:(v)=>
		if "number"==type v
			@_apply v,(a,b)->a*b
		else if istype v,Vec
			-- dot product
			@x*v.x+@y*v.y
	__unm:=>@ * -1
	_apply:(v,f)=>
		if "number"== type v
			Vec f(@x,v),f(@y,v)
		else if istype v,Vec
			Vec f(@x,v.x),f(@y,v.y)
	__eq:(v)=>istype(v,Vec) and
		@x==v.x and @y==v.y
	__tostring:=>"[x:#{@x} y:#{@y}]"
	lensq:=>@x*@x+@y*@y
	__len:=>
		if @x == 0 or @y == 0
			0
		else
			math.abs math.sqrt(@lensq!)
	clamp:(min,max)=>
		Vec math.min(math.max(@x,min.x),max.x),
			math.min(math.max(@y,min.y),max.y)
	distance:(v)=>
		dx,dy=@x-v.x,@y-v.y
		math.abs math.sqrt(dx*dx+dy*dy)
	norm:()=> Vec @x/#@,@y/#@

v1=Vec 2,2
t=TransformSet!
t\reflect_x!
v2=Vec.from t\apply(v1\to_mtrx!)
assert v2.x == -2 and v2.y == 2, "expect v2 to be [-2,2] but was #{v2}"

class Behavior
	new:(o={})=>
		@order=o.order or 0
	update:(game,actor)=>

class Player extends Behavior
	new:(o={})=>
		super o
	update:(game,actor)=>
		dx,dy=0,0
		if btn 0
			dy=-1
		if btn 1
			dy=1
		if btn 2
			dx=-1
		if btn 3
			dx=1
		if game\hit_x actor,dx,dy
			dx=0
		if game\hit_y actor,dx,dy
			dy=0
		actor.pos.x+=dx
		actor.pos.y+=dy

class Ouch extends Behavior
	new:(o={})=>
		super o
	update:(game,actor)=>
		if btn 7
			game.camera.shake=true
			game.shake=2

class FlipX extends Behavior
	new:(o={})=>
		super o
	update:(game,actor)=>
		if btn 2
			actor.flip=0
		if btn 3
			actor.flip=1

class Behavioral
	new:(o={})=>
		@behaviors=o.behaviors or {}
		for b in *@behaviors
			assert istype b,Behavior
	update:(game,scene)=>
		table.sort @behaviors,comp("order")
		for b in *@behaviors
			b\update game,scene,@
	draw:(game,scene)=>

class Actor extends Behavioral
	new:(o={})=>
		super o
		@pos=o.pos or Vec o.x,o.y
		@origin=Vec!
		@w=o.w or 16
		@h=o.h or 16
		@sprite=o.sprite or Sprite!
		@behaviors=o.behaviors or {}
		for b in *@behaviors
			assert istype b,Behavior
	update:(game)=>
		table.sort @behaviors,comp("order")
		for b in *@behaviors
			b\update game,@
		@sprite\update game,@,@
	draw:(game)=>
		@sprite\draw game,@,@
		if DEBUG
			x,y,w,h=@hitbox!
			trace "actor orig:#{@origin} pos:#{@pos}"
			rectb x,y,w,h,3
			print "x:#{@pos.x} y:#{@pos.y}",x+w,y+h,3
	hitbox:=>
		@pos.x-@w/2,@pos.y-@h/2,@w,@h
	aabb:=>
		@pos.x-@w/2,@pos.y-@w/2,@pos.x+@w/2,@pos.y+@h/2

class Sprite
	new:(o={})=>
		@id=o.id or 0
		@x=0
		@y=0
		@colorkey=o.colorkey or -1
		@transforms=TransformSet!
		@w=o.w or 1
		@h=o.h or 1
		@z_index=o.z_index or 0
		@flip=0
	update:(game,actor,parent)=>
		@flip=parent.flip
		p=parent.origin+parent.pos
		@x=p.x
		@y=p.y
	draw:(game,actor,parent)=>
		spr @id,
			@x-@w*4,@y-@h*4,
			@colorkey,
			1,@flip,0,
			@w,@h
		if DEBUG
			trace "spr x:#{@x} y:#{@y}"
			--print "x:#{@x} y:#{@y} flip:#{@flip}",@x,@y-8,3,0,1,1

class SpriteSet extends Sprite
	new:(o={})=>
		super o
		@pos=o.pos or Vec o.x,o.y
		@origin=Vec!
		@sprites=o.sprites or {}
		for s in *@sprites
			assert istype s,Sprite
	update:(game,actor,parent)=>
		table.sort @sprites,comp 'z_index'
		@origin=parent.origin+parent.pos
		if @flip!=parent.flip
			@flip=parent.flip
			--@transforms\rotate_around_axis 360,actor.pos.x,actor.pos.y
			--@pos=Vec.from @transforms\apply(@pos\to_mtrx!)
			@pos=Vec @pos.x*-1,@pos.y
		for s in *@sprites
			s\update game,actor,@
	draw:(game,actor,parent)=>
		if DEBUG
			pix @origin.x,@origin.y,4
			circb @origin.x,@origin.y,2,4
			line @origin.x,@origin.y,@origin.x+@pos.x,@origin.y+@pos.y,4
			trace "set o:#{@origin} p:#{@pos}"
		for s in *@sprites
			s\draw game,actor,@

class Game
	new:(o={})=>
		@t=0
		@actors=o.actors or {}
		@camera=o.camera or {}
		@shake=0
	update:=>
		@t+=1
		for e in *@actors
			e\update @
	draw:=>
		cls 13
		map!
		for e in *@actors
			e\draw @
		@camera_shake!
	issolid:(x,y)=>fget mget(x//8,y//8),0
	hit_x:(actor,dx,dy)=>
		x1,y1,x2,y2=actor\aabb!
		for x=x1,x2
			if @issolid(x+dx,y1)
				return true
	hit_y:(actor,dx,dy)=>
		x1,y1,x2,y2=actor\aabb!
		for y=y1,y2
			if @issolid(x1+dx,y+dy)
				return true
	camera_shake:=>
		if @camera.shake
			if @shake>0
				d=1
				poke 0x3FF9,math.random(-d,d)
				poke 0x3FF9+1,math.random(-d,d)
				@shake-=1
				if @shake==0
					memset 0x3FF9,0,2
					@camera.shake=false

export BOOT=->
	export game=Game
		actors:{
			Actor
				pos:Vec 96,24
				behaviors:{
					Player!
					Ouch!
					FlipX!
				}
				sprite:SpriteSet
					pos:Vec 0,0
					sprites:{
						Sprite
							id:1
							colorkey:14
							w:2
							h:2
						SpriteSet
							x:1
							y:-10
							sprites:{
								Sprite
									id:5 --hat
									colorkey:0
									w:2
									z_index:2
							}
						SpriteSet
							x:11
							y:0
							sprites:{
								Sprite
									id:7 --sword
									colorkey:0
									z_index:1
							}
					}
		}

export TIC=->
	game\update!
	game\draw!

-- <TILES>
-- 001:eccccccccc888888caaaaaaaca888888cacccccccacc0ccccacc0ccccacc0ccc
-- 002:ccccceee8888cceeaaaa0cee888a0ceeccca0ccc0cca0c0c0cca0c0c0cca0c0c
-- 003:eccccccccc888888caaaaaaaca888888cacccccccacccccccacc0ccccacc0ccc
-- 004:ccccceee8888cceeaaaa0cee888a0ceeccca0cccccca0c0c0cca0c0c0cca0c0c
-- 005:0002222200242222024442220244422302222223022233332222222222222222
-- 006:2220000032220000232200002232200022322000333320002222222022222222
-- 007:dd000000edd000000edd000000edd003000edd300000e3e000003ffe000300ff
-- 017:cacccccccaaaaaaacaaacaaacaaaaccccaaaaaaac8888888cc000cccecccccec
-- 018:ccca00ccaaaa0ccecaaa0ceeaaaa0ceeaaaa0cee8888ccee000cceeecccceeee
-- 019:cacccccccaaaaaaacaaacaaacaaaaccccaaaaaaac8888888cc000cccecccccec
-- 020:ccca00ccaaaa0ccecaaa0ceeaaaa0ceeaaaa0cee8888ccee000cceeecccceeee
-- 024:d000000000000000000000000000000000000000000000000000000000000000
-- 032:2022202000000000222022200000000020222020000000002220222000000000
-- 048:eeeeeed08eeeede088dddee088dddee088dddee08f888ee0f88888e000000000
-- </TILES>

-- <MAP>
-- 000:020202020202020202020202020202020202020202020202020202020202020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 001:020000000000000000000000000000000000000002020203030303030202000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 002:020000000000000000000000000000000000000000000000030303030202000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 003:020000000000000000000000000000000000000000000000000000000202000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 004:020000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 005:020000000000000000000000000000000000000000000000000000000202000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 006:030200000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 007:030200000000000000000000000000000000000000000000000000000202000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 008:030200000000000000000000000000000000000000000000000000000202000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 009:030200000000000000000000000000000000000000000000000000000202000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 010:030200000000000000000000000000000000000000000000000000020202000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 011:030200000000000000000000000000000000000000000000000000020202000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 012:030200000000000000000000000000000000000000000000000000020202000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 013:030200000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 014:030200000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 015:020200000000000000000000000000000000000000000000020202020002000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 016:020202020202020202020202020202020202020202020202020303030202000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 135:000000000000000002020202000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- </MAP>

-- <WAVES>
-- 000:00000000ffffffff00000000ffffffff
-- 001:0123456789abcdeffedcba9876543210
-- 002:0123456789abcdef0123456789abcdef
-- </WAVES>

-- <SFX>
-- 000:000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000304000000000
-- </SFX>

-- <TRACKS>
-- 000:100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- </TRACKS>

-- <FLAGS>
-- 000:00000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- </FLAGS>

-- <PALETTE>
-- 000:1a1c2c5d275db13e53ef7d57ffcd75a7f07038b76425717929366f3b5dc941a6f673eff7f4f4f494b0c2566c86333c57
-- </PALETTE>

